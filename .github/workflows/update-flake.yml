name: "update flakes"

on:
  workflow_dispatch:
  schedule:
    - cron: "30 11 * * 1"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        ref: main
        fetch-depth: 0
    - uses: cachix/install-nix-action@v17
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes

    - uses: cachix/cachix-action@v10
      continue-on-error: true
      with:
        name: "${{ github.repository_owner }}"
        extraPullNames: 'nix-community'

    - name: install fish
      run: |
        sudo apt install fish

    - name: update system
      run: |
        git config user.name '${{ github.actor }}'
        git config user.email '${{ github.actor }}@users.noreply.github.com'
        git fetch
        git checkout origin/main -B main
        fish -c "export DOTFILES=(pwd); \
          source ./dot/config/fish/functions/update.fish; \
          source ./dot/config/fish/functions/unlock.fish; \
          source ./dot/config/fish/functions/+.fish; \
          update;"
        git commit -am "❄️: flake update"
        git push -f origin main:flake-update
        gh pr create --title "❄️" --base main --head flake-update --body ":tada:" || echo pr already exists
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_SCOPED_TOKEN }}
